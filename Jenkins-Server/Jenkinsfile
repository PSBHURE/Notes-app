pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID     = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
        AWS_DEFAULT_REGION    = 'ap-south-1'
    }

    stages {

        stage('User Approval') {
            steps {
                script {
                    // Prompt user for action
                    def userChoice = input(
                        message: 'What do you want to do?',
                        parameters: [
                            choice(name: 'ACTION', choices: ['Apply', 'Destroy'], description: 'Select an action')
                        ]
                    )
                    env.ACTION = userChoice
                }
            }
        }

        stage('Execute Terraform Action') {
            steps {
                script {
                    if (env.ACTION == 'Apply') {
                        echo "✅ Applying Terraform changes..."

                        dir('Terraform/bootstrap') {
                            sh "terraform init"
                            sh "terraform plan -out=tfplan1"
                            sh "terraform show -no-color tfplan1 > tfplan1.txt"
                            sh "terraform apply -auto-approve tfplan1"
                        }

                        dir('Terraform') {
                            sh "terraform init"
                            sh "terraform plan -out=tfplan"
                            sh "terraform show -no-color tfplan > tfplan.txt"
                            sh "terraform apply -auto-approve tfplan"
                        }

                    } else if (env.ACTION == 'Destroy') {
                        echo "⚠️ Destroying all Terraform-managed resources..."

                        dir('Terraform') {
                            sh "terraform init"
                            sh "terraform destroy -auto-approve"
                        }

                        // dir('Terraform/bootstrap') {
                        //     sh "terraform init"
                        //     sh "terraform destroy -auto-approve"
                        // }

                    } else {
                        error("❌ Invalid action selected: ${env.ACTION}")
                    }
                }
            }
        }
    }
}
